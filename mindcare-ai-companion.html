<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MindCare Connect AI - Your Personal Mental Health Companion</title>

    <!-- External Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #6366F1;
            --primary-dark: #4F46E5;
            --secondary: #10B981;
            --accent: #F59E0B;
            --danger: #EF4444;
            --info: #3B82F6;
            --purple: #8B5CF6;
            --pink: #EC4899;
            --gold: #FFD700;
            --ai-blue: #00D4FF;
            --ai-purple: #B794F4;
            --bg-main: #F9FAFB;
            --bg-card: #FFFFFF;
            --text-dark: #111827;
            --text-medium: #6B7280;
            --text-light: #9CA3AF;
            --border: #E5E7EB;
            --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-main);
            color: var(--text-dark);
            line-height: 1.6;
            min-height: 100vh;
            position: relative;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            padding-bottom: 80px;
        }

        /* Header */
        header {
            background: linear-gradient(135deg, var(--primary), var(--purple));
            color: white;
            padding: 25px 0;
            box-shadow: var(--shadow-lg);
            margin-bottom: 30px;
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .logo {
            font-size: 1.6em;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .ai-badge {
            background: linear-gradient(135deg, var(--ai-blue), var(--ai-purple));
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.5em;
            font-weight: 600;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .level-badge {
            position: relative;
            width: 70px;
            height: 70px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
            font-weight: bold;
            backdrop-filter: blur(10px);
            border: 3px solid rgba(255, 255, 255, 0.4);
        }

        .header-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.15);
            padding: 15px;
            border-radius: 12px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.85em;
            opacity: 0.9;
        }

        .xp-progress {
            margin-top: 10px;
            background: rgba(255, 255, 255, 0.2);
            height: 8px;
            border-radius: 10px;
            overflow: hidden;
        }

        .xp-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--gold), #FFA500);
            border-radius: 10px;
            transition: width 0.5s ease;
        }

        /* Navigation */
        nav {
            background: var(--bg-card);
            border-radius: 15px;
            box-shadow: var(--shadow-md);
            margin-bottom: 25px;
            padding: 15px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
            position: sticky;
            top: 20px;
            z-index: 100;
            border: 1px solid var(--border);
        }

        .nav-btn {
            background: transparent;
            color: var(--text-medium);
            border: none;
            padding: 12px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 0.95em;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .nav-btn:hover {
            background: var(--bg-main);
            color: var(--primary);
        }

        .nav-btn.active {
            background: var(--primary);
            color: white;
        }

        /* AI Digital Twin */
        .ai-companion {
            position: fixed;
            bottom: 120px;
            right: 30px;
            width: 100px;
            height: 100px;
            background: linear-gradient(135deg, var(--ai-blue), var(--ai-purple));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3em;
            cursor: pointer;
            box-shadow: 0 8px 25px rgba(0, 212, 255, 0.4);
            transition: all 0.3s ease;
            z-index: 999;
            animation: float 3s ease-in-out infinite;
        }

        .ai-companion:hover {
            transform: scale(1.1);
            box-shadow: 0 12px 35px rgba(0, 212, 255, 0.6);
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .ai-companion.speaking {
            animation: speaking 0.5s ease-in-out infinite;
        }

        @keyframes speaking {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .ai-speech-bubble {
            position: fixed;
            bottom: 240px;
            right: 30px;
            max-width: 350px;
            background: white;
            padding: 20px;
            border-radius: 20px;
            box-shadow: var(--shadow-lg);
            z-index: 998;
            animation: slideUp 0.3s ease;
            display: none;
        }

        .ai-speech-bubble.visible {
            display: block;
        }

        .ai-speech-bubble::after {
            content: '';
            position: absolute;
            bottom: -10px;
            right: 30px;
            width: 0;
            height: 0;
            border-left: 10px solid transparent;
            border-right: 10px solid transparent;
            border-top: 10px solid white;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Floating Chatbot Button */
        .chatbot-button {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 70px;
            height: 70px;
            background: linear-gradient(135deg, var(--primary), var(--purple));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2em;
            cursor: pointer;
            box-shadow: 0 8px 25px rgba(99, 102, 241, 0.4);
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .chatbot-button:hover {
            transform: scale(1.1);
            box-shadow: 0 12px 35px rgba(99, 102, 241, 0.6);
        }

        .chatbot-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--danger);
            color: white;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.4em;
            font-weight: bold;
        }

        /* Chatbot Window */
        .chatbot-window {
            position: fixed;
            bottom: 120px;
            right: 30px;
            width: 400px;
            height: 600px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            display: none;
            flex-direction: column;
            z-index: 1001;
            animation: slideUp 0.3s ease;
        }

        .chatbot-window.visible {
            display: flex;
        }

        .chatbot-header {
            background: linear-gradient(135deg, var(--primary), var(--purple));
            color: white;
            padding: 20px;
            border-radius: 20px 20px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chatbot-title {
            font-size: 1.2em;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .chatbot-close {
            background: none;
            border: none;
            color: white;
            font-size: 1.5em;
            cursor: pointer;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .chatbot-close:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .chatbot-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .chat-message {
            max-width: 80%;
            padding: 12px 16px;
            border-radius: 15px;
            animation: fadeIn 0.3s ease;
        }

        .chat-message.user {
            align-self: flex-end;
            background: var(--primary);
            color: white;
            border-bottom-right-radius: 5px;
        }

        .chat-message.ai {
            align-self: flex-start;
            background: var(--bg-main);
            color: var(--text-dark);
            border-bottom-left-radius: 5px;
        }

        .chat-message.system {
            align-self: center;
            background: rgba(245, 158, 11, 0.1);
            color: var(--accent);
            font-size: 0.85em;
            font-style: italic;
            text-align: center;
            max-width: 90%;
        }

        .typing-indicator {
            display: flex;
            gap: 5px;
            padding: 12px 16px;
            background: var(--bg-main);
            border-radius: 15px;
            width: fit-content;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            background: var(--text-medium);
            border-radius: 50%;
            animation: typing 1.4s ease-in-out infinite;
        }

        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 60%, 100% {
                transform: translateY(0);
                opacity: 0.7;
            }
            30% {
                transform: translateY(-10px);
                opacity: 1;
            }
        }

        .chatbot-input-area {
            padding: 20px;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 10px;
        }

        .chatbot-input {
            flex: 1;
            padding: 12px;
            border: 2px solid var(--border);
            border-radius: 25px;
            font-family: inherit;
            font-size: 0.95em;
            outline: none;
            transition: all 0.3s ease;
        }

        .chatbot-input:focus {
            border-color: var(--primary);
        }

        .chatbot-send {
            width: 45px;
            height: 45px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 1.2em;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .chatbot-send:hover {
            background: var(--primary-dark);
            transform: scale(1.05);
        }

        .chatbot-send:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Quick Actions in Chat */
        .chat-quick-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        .quick-action-btn {
            padding: 8px 16px;
            background: var(--bg-card);
            border: 2px solid var(--primary);
            color: var(--primary);
            border-radius: 20px;
            font-size: 0.85em;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .quick-action-btn:hover {
            background: var(--primary);
            color: white;
        }

        /* Sections */
        .section {
            display: none;
            animation: fadeIn 0.4s ease;
        }

        .section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Cards */
        .card {
            background: var(--bg-card);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            transition: all 0.3s ease;
            position: relative;
        }

        .card:hover {
            box-shadow: var(--shadow-lg);
            border-color: var(--primary);
        }

        .card h2 {
            color: var(--text-dark);
            margin-bottom: 15px;
            font-size: 1.4em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card h3 {
            color: var(--text-dark);
            margin-top: 20px;
            margin-bottom: 12px;
            font-size: 1.1em;
        }

        /* AI Context Box */
        .ai-context-box {
            background: linear-gradient(135deg, rgba(0, 212, 255, 0.1), rgba(183, 148, 244, 0.1));
            border: 2px solid var(--ai-blue);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            position: relative;
        }

        .ai-context-box::before {
            content: 'ü§ñ';
            position: absolute;
            top: -15px;
            left: 20px;
            background: white;
            padding: 5px 10px;
            border-radius: 10px;
            font-size: 1.5em;
        }

        .ai-context-title {
            font-weight: 600;
            color: var(--ai-blue);
            margin-bottom: 10px;
            margin-top: 5px;
        }

        .ai-insight {
            color: var(--text-dark);
            line-height: 1.6;
            margin-bottom: 10px;
        }

        .ai-progress-projection {
            margin-top: 15px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.6);
            border-radius: 10px;
        }

        /* Grid Layouts */
        .grid-2 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
        }

        .grid-3 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }

        /* Challenge Card */
        .challenge-card {
            background: linear-gradient(135deg, var(--primary), var(--purple));
            color: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: var(--shadow-lg);
            position: relative;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .challenge-progress {
            background: rgba(255, 255, 255, 0.2);
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
        }

        /* Progress */
        .progress-container {
            margin: 15px 0;
        }

        .progress-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.9em;
            color: var(--text-medium);
        }

        .progress-bar {
            width: 100%;
            height: 10px;
            background: var(--bg-main);
            border-radius: 10px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--purple));
            border-radius: 10px;
            transition: width 0.5s ease;
        }

        /* Buttons */
        .btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            box-shadow: var(--shadow);
        }

        .btn:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn-success {
            background: var(--secondary);
        }

        .btn-outline {
            background: transparent;
            border: 2px solid var(--primary);
            color: var(--primary);
        }

        .btn-outline:hover {
            background: var(--primary);
            color: white;
        }

        .btn-full {
            width: 100%;
            justify-content: center;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: var(--bg-card);
            margin: 3% auto;
            padding: 35px;
            border-radius: 20px;
            max-width: 800px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s ease;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border);
        }

        .modal-title {
            font-size: 1.5em;
            font-weight: bold;
            color: var(--text-dark);
        }

        .close {
            color: var(--text-medium);
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .close:hover {
            background: var(--bg-main);
        }

        /* Form Elements */
        .form-group {
            margin: 20px 0;
        }

        .form-label {
            display: block;
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 8px;
        }

        .form-input,
        .form-textarea,
        .form-select {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border);
            border-radius: 10px;
            font-family: inherit;
            font-size: 1em;
            transition: all 0.3s ease;
        }

        .form-input:focus,
        .form-textarea:focus,
        .form-select:focus {
            outline: none;
            border-color: var(--primary);
        }

        .form-textarea {
            resize: vertical;
            min-height: 100px;
        }

        /* Alerts */
        .alert {
            padding: 15px 20px;
            border-radius: 10px;
            margin: 15px 0;
            display: flex;
            align-items: flex-start;
            gap: 12px;
            border-left: 4px solid;
        }

        .alert-info {
            background: rgba(59, 130, 246, 0.1);
            border-color: var(--info);
        }

        .alert-success {
            background: rgba(16, 185, 129, 0.1);
            border-color: var(--secondary);
        }

        .alert-warning {
            background: rgba(245, 158, 11, 0.1);
            border-color: var(--accent);
        }

        /* Mood Options */
        .mood-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .mood-option {
            text-align: center;
            padding: 20px 15px;
            border: 3px solid var(--border);
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .mood-option:hover {
            background: var(--bg-main);
            transform: translateY(-3px);
        }

        .mood-option.selected {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .mood-emoji {
            font-size: 3em;
            display: block;
            margin-bottom: 8px;
        }

        /* Badge */
        .badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .badge-gold {
            background: rgba(255, 215, 0, 0.2);
            color: #B8860B;
        }

        /* Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .stat-box {
            background: var(--bg-card);
            border: 2px solid var(--border);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .stat-box:hover {
            border-color: var(--primary);
            box-shadow: var(--shadow-md);
        }

        .stat-box-value {
            font-size: 2.5em;
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 5px;
        }

        .stat-box-label {
            color: var(--text-medium);
            font-size: 0.9em;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .chatbot-window {
                width: calc(100vw - 40px);
                height: calc(100vh - 140px);
                right: 20px;
                bottom: 100px;
            }

            .ai-companion {
                bottom: 110px;
                right: 20px;
                width: 80px;
                height: 80px;
                font-size: 2.5em;
            }

            .ai-speech-bubble {
                max-width: calc(100vw - 120px);
                right: 20px;
                bottom: 210px;
            }

            .grid-2,
            .grid-3 {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="header-content">
            <div class="header-top">
                <div class="logo">
                    <span>üåü</span>
                    <span>MindCare Connect</span>
                    <span class="ai-badge">AI POWERED</span>
                </div>
                <div class="level-badge" id="headerLevelBadge">
                    <span id="headerLevelNumber">1</span>
                </div>
            </div>

            <div class="header-stats">
                <div class="stat-card">
                    <div class="stat-value" id="headerLevel">Beginner</div>
                    <div class="stat-label">Level</div>
                    <div class="xp-progress">
                        <div class="xp-fill" id="headerXpFill" style="width: 0%"></div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="headerPoints">0</div>
                    <div class="stat-label">Total Points</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="headerStreak">0</div>
                    <div class="stat-label">Day Streak üî•</div>
                </div>
            </div>
        </div>
    </header>

    <div class="container">
        <nav>
            <button class="nav-btn active" onclick="showSection('dashboard')">üè† Dashboard</button>
            <button class="nav-btn" onclick="showSection('checkin')">üìä Check-In</button>
            <button class="nav-btn" onclick="showSection('activities')">‚ú® Activities</button>
            <button class="nav-btn" onclick="showSection('insights')">üß† AI Insights</button>
            <button class="nav-btn" onclick="showSection('progress')">üìà Progress</button>
            <button class="nav-btn" onclick="showSection('settings')">‚öôÔ∏è Settings</button>
        </nav>

        <!-- Dashboard -->
        <div id="dashboard" class="section active">
            <div class="ai-context-box">
                <div class="ai-context-title">üëã Your AI Companion Says:</div>
                <div class="ai-insight" id="dailyAiGreeting">
                    Good morning! I'm here to support you today. Let's start with a check-in to see how you're feeling.
                </div>
                <div class="ai-progress-projection">
                    <strong>üìä Your Trajectory:</strong> Based on your recent progress, if you continue your current pace,
                    you could reach Level <span id="projectedLevel">3</span> within <span id="projectedDays">14 days</span>!
                </div>
            </div>

            <div class="grid-2">
                <div class="card">
                    <h2>üéØ Today's Focus</h2>
                    <div id="todayFocus"></div>
                </div>

                <div class="card">
                    <h2>üèÜ Quick Stats</h2>
                    <div class="stats-grid">
                        <div class="stat-box">
                            <div class="stat-box-value" id="quickStatsPoints">0</div>
                            <div class="stat-box-label">Total Points</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-box-value" id="quickStatsLevel">1</div>
                            <div class="stat-box-label">Current Level</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Check-In Section -->
        <div id="checkin" class="section">
            <div class="card">
                <h2>üìä Daily Check-In</h2>

                <div class="ai-context-box">
                    <div class="ai-context-title">ü§ñ Why This Helps:</div>
                    <div class="ai-insight">
                        Daily check-ins help you build self-awareness about your emotional patterns.
                        By tracking your mood consistently, you'll start to notice what triggers different
                        feelings and what helps you feel better. This is a core skill in Cognitive Behavioral
                        Therapy (CBT) called "mood monitoring."
                    </div>
                </div>

                <h3>How are you feeling today?</h3>
                <div class="mood-options">
                    <div class="mood-option" onclick="selectMood(1, this)">
                        <span class="mood-emoji">üò¢</span>
                        <div>Crisis</div>
                    </div>
                    <div class="mood-option" onclick="selectMood(2, this)">
                        <span class="mood-emoji">üòü</span>
                        <div>Struggling</div>
                    </div>
                    <div class="mood-option" onclick="selectMood(3, this)">
                        <span class="mood-emoji">üòê</span>
                        <div>Okay</div>
                    </div>
                    <div class="mood-option" onclick="selectMood(4, this)">
                        <span class="mood-emoji">üôÇ</span>
                        <div>Good</div>
                    </div>
                    <div class="mood-option" onclick="selectMood(5, this)">
                        <span class="mood-emoji">üòÑ</span>
                        <div>Amazing</div>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Quick Note (Optional)</label>
                    <textarea class="form-textarea" id="checkinNote"
                              placeholder="What's on your mind today?"></textarea>
                </div>

                <button class="btn btn-success btn-full" onclick="saveCheckin()">
                    <span>‚úÖ</span> Complete Check-In (+10 points)
                </button>
            </div>
        </div>

        <!-- Activities Section -->
        <div id="activities" class="section">
            <div class="card">
                <h2>‚ú® Therapeutic Activities</h2>

                <div class="ai-context-box">
                    <div class="ai-context-title">üí° Activity Science:</div>
                    <div class="ai-insight">
                        These activities are based on evidence-based therapies like CBT, DBT, and Mindfulness-Based
                        Stress Reduction (MBSR). Regular practice rewires your brain's response to stress and improves
                        emotional regulation.
                    </div>
                </div>

                <div id="activitiesList" class="grid-3"></div>
            </div>
        </div>

        <!-- AI Insights Section -->
        <div id="insights" class="section">
            <div class="card">
                <h2>üß† AI-Powered Insights</h2>

                <div class="ai-context-box">
                    <div class="ai-context-title">üìä Your Progress Analysis:</div>
                    <div class="ai-insight" id="progressAnalysis">
                        Complete more check-ins to unlock personalized insights about your patterns and progress.
                    </div>
                </div>

                <h3>Understanding Your Condition</h3>
                <div id="conditionInsights"></div>

                <h3>Coping Strategies</h3>
                <div id="copingStrategies"></div>
            </div>
        </div>

        <!-- Progress Section -->
        <div id="progress" class="section">
            <div class="card">
                <h2>üìà Your Journey</h2>
                <div class="stats-grid">
                    <div class="stat-box">
                        <div class="stat-box-value" id="progressPoints">0</div>
                        <div class="stat-box-label">Total Points</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-box-value" id="progressLevel">1</div>
                        <div class="stat-box-label">Current Level</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-box-value" id="progressStreak">0</div>
                        <div class="stat-box-label">Day Streak</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Settings Section -->
        <div id="settings" class="section">
            <div class="card">
                <h2>‚öôÔ∏è Settings</h2>

                <h3>AI Companion Preferences</h3>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="settingAiTips" checked>
                        Show contextual AI tips during activities
                    </label>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="settingAiEncouragement" checked>
                        Enable AI encouragement messages
                    </label>
                </div>

                <h3>Data Sharing</h3>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="settingShareCaregiver">
                        Allow AI to generate reports for caregivers
                    </label>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="settingSharePsychiatrist">
                        Allow AI to generate reports for psychiatrist
                    </label>
                </div>

                <button class="btn btn-success btn-full" onclick="saveSettings()">
                    üíæ Save Settings
                </button>
            </div>
        </div>
    </div>

    <!-- AI Digital Twin Companion -->
    <div class="ai-companion" id="aiCompanion" onclick="toggleAiSpeech()">
        ü§ñ
    </div>

    <div class="ai-speech-bubble" id="aiSpeechBubble">
        <div id="aiSpeechText">Hi! I'm your AI companion. Click the chat button to talk to me anytime!</div>
    </div>

    <!-- Floating Chatbot Button -->
    <div class="chatbot-button" id="chatbotButton" onclick="toggleChatbot()">
        üí¨
        <div class="chatbot-badge" id="chatbotBadge" style="display: none;">1</div>
    </div>

    <!-- Chatbot Window -->
    <div class="chatbot-window" id="chatbotWindow">
        <div class="chatbot-header">
            <div class="chatbot-title">
                <span>ü§ñ</span>
                <span>AI Mental Health Assistant</span>
            </div>
            <button class="chatbot-close" onclick="toggleChatbot()">√ó</button>
        </div>

        <div class="chatbot-messages" id="chatbotMessages">
            <div class="chat-message system">
                ‚ö†Ô∏è This AI provides evidence-based information but does NOT replace professional psychiatric care.
                Always consult your healthcare provider for medical decisions.
            </div>
            <div class="chat-message ai">
                Hi! I'm your AI mental health assistant. I can help you with:
                <div class="chat-quick-actions">
                    <button class="quick-action-btn" onclick="quickAction('exercise')">Create Custom Exercise</button>
                    <button class="quick-action-btn" onclick="quickAction('resources')">Find Resources</button>
                    <button class="quick-action-btn" onclick="quickAction('report')">Generate Report</button>
                    <button class="quick-action-btn" onclick="quickAction('question')">Ask Question</button>
                </div>
            </div>
        </div>

        <div class="chatbot-input-area">
            <input type="text" class="chatbot-input" id="chatbotInput"
                   placeholder="Type your message..." onkeypress="handleChatKeypress(event)">
            <button class="chatbot-send" id="chatbotSend" onclick="sendChatMessage()">
                ‚û§
            </button>
        </div>
    </div>

    <!-- Modal -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="modalTitle">Modal</div>
                <span class="close" onclick="closeModal()">√ó</span>
            </div>
            <div id="modalBody"></div>
        </div>
    </div>

    <script>
        // ==================== APP STATE ====================
        let appState = {
            version: 3,
            user: {
                name: 'Friend',
                streak: 0,
                lastCheckIn: null
            },

            gamification: {
                points: 0,
                level: 1,
                xp: 0,
                xpToNextLevel: 100
            },

            aiSettings: {
                showTips: true,
                showEncouragement: true,
                shareWithCaregiver: false,
                shareWithPsychiatrist: false
            },

            checkins: [],
            activities: [],
            chatHistory: [],
            selectedMood: null
        };

        // ==================== AI KNOWLEDGE BASE ====================
        const AI_KNOWLEDGE = {
            conditions: {
                depression: {
                    name: "Depression",
                    symptoms: ["persistent sadness", "loss of interest", "fatigue", "sleep changes"],
                    treatments: ["CBT", "medication", "exercise", "social connection"],
                    insights: "Depression affects brain chemistry, particularly serotonin and dopamine. Treatment helps restore balance."
                },
                anxiety: {
                    name: "Anxiety",
                    symptoms: ["excessive worry", "restlessness", "racing thoughts", "physical tension"],
                    treatments: ["CBT", "exposure therapy", "breathing exercises", "mindfulness"],
                    insights: "Anxiety is your brain's alarm system being too sensitive. We can retrain it through gradual exposure."
                }
            },

            copingStrategies: [
                {
                    name: "Deep Breathing (4-7-8)",
                    why: "Activates parasympathetic nervous system, reducing fight-or-flight response",
                    when: "Use when feeling anxious or stressed",
                    research: "Studies show deep breathing lowers cortisol within 5 minutes"
                },
                {
                    name: "Behavioral Activation",
                    why: "Doing enjoyable activities increases dopamine, improving mood",
                    when: "Use when feeling depressed or withdrawn",
                    research: "Research shows behavioral activation as effective as antidepressants for mild depression"
                },
                {
                    name: "Cognitive Restructuring",
                    why: "Changing thought patterns changes emotions and behavior",
                    when: "Use when stuck in negative thinking",
                    research: "CBT's core technique, proven effective in 1000+ studies"
                },
                {
                    name: "Progressive Muscle Relaxation",
                    why: "Releases physical tension, signals brain to calm down",
                    when: "Use for sleep issues or physical anxiety symptoms",
                    research: "Shown to reduce anxiety symptoms by 30-50% in clinical trials"
                }
            ],

            activityBenefits: {
                breathing: "Breathing exercises activate your vagus nerve, which tells your brain to calm down. Research shows just 5 minutes can lower anxiety by 30%.",
                walk: "Walking releases endorphins and increases BDNF (brain fertilizer). Studies show 15-minute walks improve mood for up to 2 hours.",
                gratitude: "Gratitude journaling increases dopamine and serotonin by 10%. It rewires your brain to notice positives.",
                bodyscan: "Body scans enhance interoception (body awareness), helping you catch stress early. Used in MBSR programs worldwide.",
                social: "Social connection releases oxytocin, reducing cortisol. Loneliness is as harmful as smoking 15 cigarettes daily.",
                exercise: "Exercise is as effective as antidepressants for mild depression. It increases neurogenesis in the hippocampus."
            },

            encouragement: [
                "Every small step counts. You're building new neural pathways!",
                "Progress isn't linear. Some days are harder, and that's okay.",
                "You're showing up for yourself. That takes courage.",
                "Remember: healing is a journey, not a destination.",
                "Your brain is plastic - it can change. You're proving that right now.",
                "Setbacks are part of recovery. They don't erase your progress.",
                "You're stronger than you think. Look how far you've come!"
            ]
        };

        // ==================== ACTIVITIES DATABASE ====================
        const ACTIVITIES_DB = [
            {
                id: 'breathing',
                icon: 'üå¨Ô∏è',
                name: '4-7-8 Breathing',
                desc: 'Calm your nervous system',
                points: 15,
                aiContext: "This activates your parasympathetic nervous system, literally telling your body to relax."
            },
            {
                id: 'walk',
                icon: 'üö∂',
                name: 'Mindful Walk',
                desc: 'Connect with the present moment',
                points: 15,
                aiContext: "Walking boosts BDNF (brain-derived neurotrophic factor), which helps your brain grow new connections."
            },
            {
                id: 'gratitude',
                icon: 'üìù',
                name: 'Gratitude Journal',
                desc: 'Rewire your brain for positivity',
                points: 20,
                aiContext: "Gratitude increases dopamine and serotonin, the same chemicals targeted by antidepressants."
            },
            {
                id: 'bodyscan',
                icon: 'üßò',
                name: 'Body Scan Meditation',
                desc: 'Release physical tension',
                points: 15,
                aiContext: "Body scans improve interoception, helping you notice and manage stress before it escalates."
            },
            {
                id: 'social',
                icon: 'üë•',
                name: 'Social Connection',
                desc: 'Reach out to someone',
                points: 15,
                aiContext: "Social connection releases oxytocin, which reduces stress hormones and improves mood."
            },
            {
                id: 'exercise',
                icon: 'üí™',
                name: 'Gentle Exercise',
                desc: 'Move your body',
                points: 20,
                aiContext: "Exercise increases neurogenesis (new brain cells) and is as effective as medication for mild depression."
            }
        ];

        // ==================== CHATBOT AI ENGINE ====================
        const ChatAI = {
            patterns: {
                greeting: /^(hi|hello|hey|good morning|good evening)/i,
                help: /\b(help|what can you do|assist|support)\b/i,
                exercise: /\b(exercise|activity|custom|create|personalize)\b/i,
                resources: /\b(resource|article|video|learn|information)\b/i,
                report: /\b(report|share|send|caregiver|doctor|psychiatrist)\b/i,
                question: /\b(why|how|what|when|explain|understand)\b/i,
                mood: /\b(mood|feel|feeling|emotion|sad|anxious|depressed|happy)\b/i,
                medication: /\b(medication|medicine|pill|dose|side effect)\b/i,
                crisis: /\b(suicide|kill myself|end my life|hurt myself|crisis)\b/i,
                progress: /\b(progress|improve|better|worse|change)\b/i,
                coping: /\b(cope|coping|deal with|manage|handle)\b/i
            },

            respond(message) {
                const msg = message.toLowerCase().trim();

                // Crisis detection - highest priority
                if (this.patterns.crisis.test(msg)) {
                    return {
                        text: "üÜò I'm concerned about you. Please reach out for immediate help:\n\n" +
                              "üìû Call or text 988 (Suicide & Crisis Lifeline)\n" +
                              "üí¨ Text HOME to 741741 (Crisis Text Line)\n" +
                              "üö® Or call 911 if you're in immediate danger\n\n" +
                              "You matter, and help is available 24/7. Please connect with a crisis counselor right now.",
                        actions: []
                    };
                }

                if (this.patterns.greeting.test(msg)) {
                    return {
                        text: `Hello! üëã I'm your AI mental health assistant. I'm here to help you with evidence-based support.

What would you like to do today?`,
                        actions: ['Create Exercise', 'Find Resources', 'Generate Report', 'Ask Question']
                    };
                }

                if (this.patterns.exercise.test(msg)) {
                    return {
                        text: `I can create a personalized exercise for you! üéØ

Tell me what you're working on:
‚Ä¢ Managing anxiety?
‚Ä¢ Improving mood?
‚Ä¢ Better sleep?
‚Ä¢ Building confidence?
‚Ä¢ Something else?

Or I can suggest an exercise based on your recent check-ins.`,
                        actions: ['Suggest Based on My Data', 'Anxiety Exercise', 'Mood Exercise', 'Sleep Exercise']
                    };
                }

                if (this.patterns.resources.test(msg)) {
                    return {
                        text: `I can help you find evidence-based resources! üìö

What topic are you interested in?
‚Ä¢ Understanding your condition
‚Ä¢ Coping strategies
‚Ä¢ Medication information
‚Ä¢ Therapy techniques (CBT, DBT, etc.)
‚Ä¢ Family/caregiver support

**Note:** These are educational resources. Always confirm specific treatment questions with your psychiatrist.`,
                        actions: ['CBT Resources', 'Anxiety Resources', 'Depression Resources', 'Mindfulness Resources']
                    };
                }

                if (this.patterns.report.test(msg)) {
                    return {
                        text: `I can generate reports to share with your care team! üìä

**Important:** Reports are only shared with your explicit permission.

I can create:
‚Ä¢ Progress summary (mood, activities, streaks)
‚Ä¢ Medication adherence report
‚Ä¢ Activity completion analysis
‚Ä¢ Crisis event log (if any)

Who would you like to share with?`,
                        actions: ['Generate Caregiver Report', 'Generate Psychiatrist Report', 'View Sample Report']
                    };
                }

                if (this.patterns.mood.test(msg)) {
                    return {
                        text: `Let's talk about mood! üòä

Mood fluctuations are completely normal, even during treatment. Here's what helps:

üîç **Track patterns:** Notice when your mood changes (time of day, activities, people)
üí° **Behavioral activation:** Do small enjoyable activities even when you don't feel like it
üåÖ **Morning routine:** Consistent wake times stabilize mood
üèÉ **Movement:** Exercise is as effective as medication for mild depression

Would you like help creating a mood management plan?

**Remember:** If you're experiencing severe mood changes, discuss with your psychiatrist.`,
                        actions: ['Create Mood Plan', 'Track Mood Patterns', 'Learn More']
                    };
                }

                if (this.patterns.medication.test(msg)) {
                    return {
                        text: `Medication questions are important! üíä

**What I can help with:**
‚Ä¢ General information about medication classes
‚Ä¢ Common side effects and management strategies
‚Ä¢ Adherence tips and reminders
‚Ä¢ When to contact your doctor

**What requires your psychiatrist:**
‚Ä¢ Dosage changes
‚Ä¢ Starting/stopping medications
‚Ä¢ Severe side effects
‚Ä¢ Drug interactions

What would you like to know?

‚ö†Ô∏è **Critical:** Never adjust medications without consulting your doctor first.`,
                        actions: ['Side Effect Help', 'Adherence Tips', 'When to Call Doctor']
                    };
                }

                if (this.patterns.progress.test(msg)) {
                    const points = appState.gamification.points;
                    const level = appState.gamification.level;
                    const streak = appState.user.streak;

                    return {
                        text: `Let's review your progress! üìà

**Your Stats:**
‚Ä¢ Level ${level} - ${getStreakEncouragement(level)}
‚Ä¢ ${points} total points earned
‚Ä¢ ${streak} day streak ${streak > 0 ? 'üî•' : ''}

**What this means:**
${getProgressAnalysis(points, streak)}

Keep going! Every small step is building new neural pathways.`,
                        actions: ['See Detailed Analysis', 'Set New Goal', 'View Projections']
                    };
                }

                if (this.patterns.coping.test(msg)) {
                    return {
                        text: `Let me share evidence-based coping strategies! üõ†Ô∏è

**Quick Relief (0-5 min):**
‚Ä¢ 4-7-8 breathing (activates calming response)
‚Ä¢ 5-4-3-2-1 grounding (anchors you in present)
‚Ä¢ Cold water on face (triggers dive reflex)

**Short-term (5-30 min):**
‚Ä¢ Mindful walk (boosts BDNF)
‚Ä¢ Progressive muscle relaxation
‚Ä¢ Journaling (externalizes thoughts)

**Long-term Building:**
‚Ä¢ Regular sleep schedule
‚Ä¢ Daily movement
‚Ä¢ Social connection
‚Ä¢ Therapy skills practice

Which would you like to try?`,
                        actions: ['Start Breathing', 'Try Grounding', 'Create Routine', 'Learn More']
                    };
                }

                // Default response
                return {
                    text: `I'd be happy to help! I can assist with:

üéØ **Creating personalized exercises** based on your needs
üìö **Finding evidence-based resources** on mental health topics
üìä **Generating reports** to share with your care team (with permission)
‚ùì **Answering questions** about conditions, treatments, and coping

What would you like to explore?

**Remember:** I provide evidence-based information, but always confirm specific medical questions with your psychiatrist.`,
                    actions: ['Create Exercise', 'Find Resources', 'Ask Question', 'Generate Report']
                };
            }
        };

        // Helper functions for AI responses
        function getStreakEncouragement(level) {
            if (level >= 8) return "Amazing dedication!";
            if (level >= 5) return "You're doing great!";
            if (level >= 3) return "Keep it up!";
            return "Great start!";
        }

        function getProgressAnalysis(points, streak) {
            if (points > 500) {
                return "Exceptional engagement! You're consistently showing up for yourself. This level of commitment is associated with better treatment outcomes.";
            } else if (points > 200) {
                return "Strong progress! You're building healthy habits. Research shows consistency matters more than intensity.";
            } else if (points > 50) {
                return "You're on the right track! Early engagement is crucial. Keep building on this momentum.";
            } else {
                return "Every journey starts with small steps. You're here, and that's what matters. Let's build together!";
            }
        }

        // ==================== CORE FUNCTIONS ====================

        function awardPoints(activity, amount) {
            appState.gamification.points += amount;
            appState.gamification.xp += amount;

            updateHeader();
            saveData();

            if (confetti) {
                confetti({
                    particleCount: 30,
                    spread: 60,
                    origin: { y: 0.6 }
                });
            }
        }

        function selectMood(value, element) {
            document.querySelectorAll('.mood-option').forEach(m => m.classList.remove('selected'));
            element.classList.add('selected');
            appState.selectedMood = value;
        }

        function saveCheckin() {
            if (!appState.selectedMood) {
                alert('Please select your mood first!');
                return;
            }

            const today = new Date().toDateString();
            const lastCheckIn = appState.user.lastCheckIn ? new Date(appState.user.lastCheckIn).toDateString() : null;

            awardPoints('checkin', 10);

            if (lastCheckIn !== today) {
                if (lastCheckIn === new Date(Date.now() - 86400000).toDateString()) {
                    appState.user.streak++;
                } else {
                    appState.user.streak = 1;
                }
                appState.user.lastCheckIn = new Date().toISOString();
            }

            appState.checkins.push({
                date: new Date().toISOString(),
                mood: appState.selectedMood,
                note: document.getElementById('checkinNote').value
            });

            saveData();
            updateHeader();

            // Show AI encouragement
            showAiMessage(AI_KNOWLEDGE.encouragement[Math.floor(Math.random() * AI_KNOWLEDGE.encouragement.length)]);

            showModal('‚úÖ Check-In Complete!', `
                <div style="text-align: center;">
                    <div style="font-size: 5em; margin-bottom: 20px;">üéâ</div>
                    <h2>Great job checking in!</h2>
                    <p style="margin: 20px 0;">You earned <strong class="badge badge-gold">+10 points</strong></p>
                    <p>Current streak: <strong>${appState.user.streak} days üî•</strong></p>
                    <div class="ai-context-box" style="margin-top: 20px;">
                        <div class="ai-context-title">ü§ñ Why This Matters:</div>
                        <div class="ai-insight">
                            Consistent mood tracking helps you identify patterns and triggers.
                            You're building valuable self-awareness!
                        </div>
                    </div>
                    <button class="btn btn-success btn-full" style="margin-top: 25px;" onclick="closeModal()">
                        Continue
                    </button>
                </div>
            `);
        }

        function completeActivity(id) {
            const activity = ACTIVITIES_DB.find(a => a.id === id);
            if (!activity) return;

            appState.activities.push({
                id: id,
                date: new Date().toISOString()
            });

            awardPoints('activity', activity.points);
            saveData();

            showModal('üéâ Activity Complete!', `
                <div style="text-align: center;">
                    <div style="font-size: 5em; margin-bottom: 20px;">${activity.icon}</div>
                    <h2>${activity.name}</h2>
                    <p style="margin: 20px 0;">You earned <strong class="badge badge-gold">+${activity.points} points</strong></p>

                    <div class="ai-context-box" style="margin-top: 20px; text-align: left;">
                        <div class="ai-context-title">ü§ñ The Science Behind This:</div>
                        <div class="ai-insight">
                            ${AI_KNOWLEDGE.activityBenefits[id]}
                        </div>
                    </div>

                    <button class="btn btn-success btn-full" style="margin-top: 25px;" onclick="closeModal()">
                        Continue
                    </button>
                </div>
            `);
        }

        function renderActivities() {
            const container = document.getElementById('activitiesList');
            if (!container) return;

            container.innerHTML = ACTIVITIES_DB.map(activity => `
                <div class="card" style="cursor: pointer; text-align: center;" onclick="completeActivity('${activity.id}')">
                    <div style="font-size: 3em; margin-bottom: 10px;">${activity.icon}</div>
                    <h3 style="margin: 10px 0;">${activity.name}</h3>
                    <p style="color: var(--text-medium); margin-bottom: 10px; min-height: 40px;">${activity.desc}</p>
                    <span class="badge badge-gold">+${activity.points} points</span>
                    <div style="margin-top: 10px; font-size: 0.85em; color: var(--ai-blue);">
                        ü§ñ AI Tip: ${activity.aiContext}
                    </div>
                </div>
            `).join('');
        }

        // ==================== AI COMPANION ====================

        function toggleAiSpeech() {
            const bubble = document.getElementById('aiSpeechBubble');
            const companion = document.getElementById('aiCompanion');

            if (bubble.classList.contains('visible')) {
                bubble.classList.remove('visible');
                companion.classList.remove('speaking');
            } else {
                const messages = [
                    "Remember: progress, not perfection!",
                    "You're building resilience every day.",
                    "Small steps lead to big changes.",
                    "I'm proud of you for showing up!",
                    "Your brain is capable of amazing change.",
                    "Every activity strengthens new neural pathways."
                ];
                const randomMessage = messages[Math.floor(Math.random() * messages.length)];
                document.getElementById('aiSpeechText').textContent = randomMessage;
                bubble.classList.add('visible');
                companion.classList.add('speaking');

                setTimeout(() => {
                    bubble.classList.remove('visible');
                    companion.classList.remove('speaking');
                }, 5000);
            }
        }

        function showAiMessage(message) {
            const bubble = document.getElementById('aiSpeechBubble');
            const companion = document.getElementById('aiCompanion');

            document.getElementById('aiSpeechText').textContent = message;
            bubble.classList.add('visible');
            companion.classList.add('speaking');

            setTimeout(() => {
                bubble.classList.remove('visible');
                companion.classList.remove('speaking');
            }, 5000);
        }

        // ==================== CHATBOT ====================

        function toggleChatbot() {
            const window = document.getElementById('chatbotWindow');
            const badge = document.getElementById('chatbotBadge');

            if (window.classList.contains('visible')) {
                window.classList.remove('visible');
            } else {
                window.classList.add('visible');
                badge.style.display = 'none';
            }
        }

        function sendChatMessage() {
            const input = document.getElementById('chatbotInput');
            const message = input.value.trim();

            if (!message) return;

            // Add user message
            addChatMessage(message, 'user');
            input.value = '';

            // Show typing indicator
            showTypingIndicator();

            // Get AI response
            setTimeout(() => {
                hideTypingIndicator();
                const response = ChatAI.respond(message);
                addChatMessage(response.text, 'ai');

                if (response.actions && response.actions.length > 0) {
                    addQuickActions(response.actions);
                }

                // Save to history
                appState.chatHistory.push({
                    user: message,
                    ai: response.text,
                    timestamp: new Date().toISOString()
                });
                saveData();
            }, 1000 + Math.random() * 1000);
        }

        function addChatMessage(text, sender) {
            const container = document.getElementById('chatbotMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${sender}`;
            messageDiv.innerHTML = text.replace(/\n/g, '<br>');
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
        }

        function addQuickActions(actions) {
            const container = document.getElementById('chatbotMessages');
            const actionsDiv = document.createElement('div');
            actionsDiv.className = 'chat-message ai';
            actionsDiv.innerHTML = `
                <div class="chat-quick-actions">
                    ${actions.map(action =>
                        `<button class="quick-action-btn" onclick="quickActionClick('${action}')">${action}</button>`
                    ).join('')}
                </div>
            `;
            container.appendChild(actionsDiv);
            container.scrollTop = container.scrollHeight;
        }

        function quickAction(action) {
            const actions = {
                exercise: 'I want to create a custom exercise',
                resources: 'Can you suggest some resources?',
                report: 'I want to generate a report',
                question: 'I have a question about mental health'
            };

            const input = document.getElementById('chatbotInput');
            input.value = actions[action] || action;
            sendChatMessage();
        }

        function quickActionClick(action) {
            const input = document.getElementById('chatbotInput');
            input.value = action;
            sendChatMessage();
        }

        function showTypingIndicator() {
            const container = document.getElementById('chatbotMessages');
            const typingDiv = document.createElement('div');
            typingDiv.id = 'typingIndicator';
            typingDiv.className = 'typing-indicator';
            typingDiv.innerHTML = '<div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>';
            container.appendChild(typingDiv);
            container.scrollTop = container.scrollHeight;
        }

        function hideTypingIndicator() {
            const indicator = document.getElementById('typingIndicator');
            if (indicator) indicator.remove();
        }

        function handleChatKeypress(event) {
            if (event.key === 'Enter') {
                sendChatMessage();
            }
        }

        // ==================== UI FUNCTIONS ====================

        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));

            document.getElementById(sectionId).classList.add('active');
            event.target.classList.add('active');

            if (sectionId === 'activities') renderActivities();
        }

        function updateHeader() {
            document.getElementById('headerLevelNumber').textContent = appState.gamification.level;
            document.getElementById('headerLevel').textContent = 'Level ' + appState.gamification.level;
            document.getElementById('headerPoints').textContent = appState.gamification.points;
            document.getElementById('headerStreak').textContent = appState.user.streak;

            const xpProgress = (appState.gamification.xp / appState.gamification.xpToNextLevel * 100);
            document.getElementById('headerXpFill').style.width = xpProgress + '%';

            // Update quick stats
            const quickStatsPoints = document.getElementById('quickStatsPoints');
            const quickStatsLevel = document.getElementById('quickStatsLevel');
            if (quickStatsPoints) quickStatsPoints.textContent = appState.gamification.points;
            if (quickStatsLevel) quickStatsLevel.textContent = appState.gamification.level;

            // Update progress stats
            const progressPoints = document.getElementById('progressPoints');
            const progressLevel = document.getElementById('progressLevel');
            const progressStreak = document.getElementById('progressStreak');
            if (progressPoints) progressPoints.textContent = appState.gamification.points;
            if (progressLevel) progressLevel.textContent = appState.gamification.level;
            if (progressStreak) progressStreak.textContent = appState.user.streak;
        }

        function showModal(title, body) {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalBody').innerHTML = body;
            document.getElementById('modal').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('modal').style.display = 'none';
        }

        function saveSettings() {
            appState.aiSettings.showTips = document.getElementById('settingAiTips').checked;
            appState.aiSettings.showEncouragement = document.getElementById('settingAiEncouragement').checked;
            appState.aiSettings.shareWithCaregiver = document.getElementById('settingShareCaregiver').checked;
            appState.aiSettings.shareWithPsychiatrist = document.getElementById('settingSharePsychiatrist').checked;

            saveData();
            alert('Settings saved!');
        }

        window.onclick = function(event) {
            const modal = document.getElementById('modal');
            if (event.target === modal) closeModal();
        }

        // ==================== DATA PERSISTENCE ====================

        function saveData() {
            localStorage.setItem('mindcareAiData', JSON.stringify(appState));
        }

        function loadData() {
            const saved = localStorage.getItem('mindcareAiData');
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    appState = { ...appState, ...data };
                } catch (e) {
                    console.error('Error loading data:', e);
                }
            }
        }

        // ==================== INITIALIZATION ====================

        function init() {
            loadData();
            updateHeader();
            renderActivities();

            // Show welcome message
            setTimeout(() => {
                showAiMessage("Hi! I'm your AI companion. Click me anytime for encouragement!");
            }, 2000);

            // Auto-save
            setInterval(saveData, 30000);
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
